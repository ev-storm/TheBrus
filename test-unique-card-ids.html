<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–¢–µ—Å—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö ID –∫–∞—Ä—Ç–æ—á–µ–∫</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: #1a1a1a;
        color: white;
      }
      .test-section {
        background: #2a2a2a;
        padding: 20px;
        margin: 20px 0;
        border-radius: 8px;
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
      }
      .success {
        background: #4caf50;
      }
      .error {
        background: #f44336;
      }
      .info {
        background: #2196f3;
      }
      .test-button {
        background: #65c36c;
        color: white;
        border: none;
        padding: 10px 20px;
        margin: 5px;
        border-radius: 4px;
        cursor: pointer;
      }
      .test-button:hover {
        background: #5ab060;
      }
      .card {
        background: #444;
        padding: 15px;
        margin: 10px 0;
        border-radius: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 2px solid transparent;
        transition: all 0.3s ease;
      }
      .card.favorite {
        border-color: #65c36c;
        background: #3a4a3a;
      }
      .like-button {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        font-size: 20px;
        transition: all 0.3s ease;
      }
      .like-button.liked {
        color: #65c36c;
        transform: scale(1.2);
      }
      .like-button:hover {
        color: #65c36c;
      }
      .test-results {
        background: #333;
        padding: 15px;
        border-radius: 4px;
        margin: 10px 0;
        font-family: monospace;
        white-space: pre-wrap;
      }
      .sort-buttons {
        display: flex;
        gap: 10px;
        margin: 10px 0;
      }
      .sort-button {
        background: #ff9800;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
      }
      .sort-button.active {
        background: #65c36c;
      }
      .id-display {
        font-size: 12px;
        color: #888;
        margin-top: 5px;
      }
    </style>
  </head>
  <body>
    <h1>üîë –¢–µ—Å—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö ID –∫–∞—Ä—Ç–æ—á–µ–∫</h1>

    <div class="test-section">
      <h2>üìä –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã</h2>
      <div id="status" class="status info">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
      <div class="favorites-list">
        <strong>–ò–∑–±—Ä–∞–Ω–Ω–æ–µ:</strong>
        <span id="favorites-count">0</span> —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        <div id="favorites-list"></div>
      </div>
    </div>

    <div class="test-section">
      <h2>üîÑ –¢–µ—Å—Ç —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ª–∞–π–∫–æ–≤</h2>
      <div class="sort-buttons">
        <button class="sort-button" onclick="sortBy('name')">–ü–æ –∏–º–µ–Ω–∏</button>
        <button class="sort-button" onclick="sortBy('price-asc')">
          –ü–æ —Ü–µ–Ω–µ ‚Üë
        </button>
        <button class="sort-button" onclick="sortBy('price-desc')">
          –ü–æ —Ü–µ–Ω–µ ‚Üì
        </button>
        <button class="sort-button" onclick="sortBy('area-asc')">
          –ü–æ –ø–ª–æ—â–∞–¥–∏ ‚Üë
        </button>
        <button class="sort-button" onclick="sortBy('area-desc')">
          –ü–æ –ø–ª–æ—â–∞–¥–∏ ‚Üì
        </button>
      </div>
      <div id="cards-container">
        <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
      </div>
    </div>

    <div class="test-section">
      <h2>üß™ –¢–µ—Å—Ç—ã —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏</h2>
      <button class="test-button" onclick="runUniqueIdTests()">
        –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö ID
      </button>
      <button class="test-button" onclick="testSortingWithLikes()">
        –¢–µ—Å—Ç —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —Å –ª–∞–π–∫–∞–º–∏
      </button>
      <button class="test-button" onclick="clearFavorites()">
        –û—á–∏—Å—Ç–∏—Ç—å –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
      </button>
      <div id="test-results" class="test-results"></div>
    </div>

    <script>
      // –°–∏–º—É–ª—è—Ü–∏—è useCardId
      class CardIdManager {
        getCardId(item, tab) {
          if (!item || !tab) {
            console.warn("CardIdManager: item –∏–ª–∏ tab –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã", {
              item,
              tab,
            });
            return "unknown";
          }
          const baseId = `${tab}-${item.name}`;
          const hash = item.price ? item.price.toString() : "0";
          return `${baseId}-${hash}`;
        }

        parseCardId(cardId) {
          if (!cardId) return null;
          const parts = cardId.split("-");
          if (parts.length < 2) return null;
          return {
            tab: parts[0],
            name: parts.slice(1, -1).join("-"),
            hash: parts[parts.length - 1],
          };
        }
      }

      // –°–∏–º—É–ª—è—Ü–∏—è useFavorites —Å cookies
      class FavoritesManager {
        constructor() {
          this.cookieName = "favorites";
          this.favorites = this.loadFromCookie();
          this.cardIdManager = new CardIdManager();
          this.currentSort = "name";
          this.updateDisplay();
        }

        loadFromCookie() {
          try {
            const cookie = document.cookie
              .split("; ")
              .find((row) => row.startsWith(this.cookieName + "="));
            if (cookie) {
              const value = cookie.split("=")[1];
              return JSON.parse(decodeURIComponent(value));
            }
          } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ cookie:", e);
          }
          return [];
        }

        saveToCookie() {
          try {
            const value = encodeURIComponent(JSON.stringify(this.favorites));
            document.cookie = `${this.cookieName}=${value}; max-age=${
              60 * 60 * 24 * 365
            }; path=/; samesite=lax`;
          } catch (e) {
            console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ cookie:", e);
          }
        }

        toggleFavorite(cardId) {
          const index = this.favorites.indexOf(cardId);
          if (index > -1) {
            this.favorites.splice(index, 1);
            console.log("–£–¥–∞–ª–µ–Ω–æ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ:", cardId);
          } else {
            this.favorites.push(cardId);
            console.log("–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ:", cardId);
          }
          this.saveToCookie();
          this.updateDisplay();
          this.updateCards();
        }

        isFavorite(cardId) {
          return this.favorites.includes(cardId);
        }

        getFavoritesCount() {
          return this.favorites.length;
        }

        clearFavorites() {
          this.favorites = [];
          this.saveToCookie();
          this.updateDisplay();
          this.updateCards();
        }

        updateDisplay() {
          document.getElementById("favorites-count").textContent =
            this.getFavoritesCount();
          const list = document.getElementById("favorites-list");
          list.innerHTML =
            this.favorites.length > 0
              ? this.favorites.map((id) => `<div>‚Ä¢ ${id}</div>`).join("")
              : "<div>–ü—É—Å—Ç–æ</div>";
        }

        updateCards() {
          const cards = document.querySelectorAll(".card");
          cards.forEach((card) => {
            const cardId = card.dataset.cardId;
            const likeButton = card.querySelector(".like-button");
            if (likeButton) {
              const isLiked = this.isFavorite(cardId);
              likeButton.classList.toggle("liked", isLiked);
              card.classList.toggle("favorite", isLiked);
            }
          });
        }

        sortItems(items, sortBy) {
          const sortedItems = [...items];
          this.currentSort = sortBy;

          switch (sortBy) {
            case "name":
              return sortedItems.sort((a, b) => a.name.localeCompare(b.name));
            case "price-asc":
              return sortedItems.sort((a, b) => a.price - b.price);
            case "price-desc":
              return sortedItems.sort((a, b) => b.price - a.price);
            case "area-asc":
              return sortedItems.sort((a, b) => a.area - b.area);
            case "area-desc":
              return sortedItems.sort((a, b) => b.area - a.area);
            default:
              return sortedItems;
          }
        }
      }

      const favoritesManager = new FavoritesManager();

      // –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
      const testData = [
        { name: "–ù–∞–∑–≤–∞–Ω–∏–µ –ü—Ä–æ–µ–∫—Ç–∞ 1", price: 9580652, area: 425 },
        { name: "–ù–∞–∑–≤–∞–Ω–∏–µ –ü—Ä–æ–µ–∫—Ç–∞ 2", price: 7340000, area: 310 },
        { name: "–ù–∞–∑–≤–∞–Ω–∏–µ –ü—Ä–æ–µ–∫—Ç–∞ 3", price: 5820000, area: 240 },
        { name: "–ù–∞–∑–≤–∞–Ω–∏–µ –ü—Ä–æ–µ–∫—Ç–∞ 4", price: 10490000, area: 460 },
        { name: "–ù–∞–∑–≤–∞–Ω–∏–µ –ü—Ä–æ–µ–∫—Ç–∞ 5", price: 6890000, area: 275 },
        { name: "–ù–∞–∑–≤–∞–Ω–∏–µ –ü—Ä–æ–µ–∫—Ç–∞ 6", price: 7990000, area: 300 },
      ];

      function renderCards(items) {
        const container = document.getElementById("cards-container");
        container.innerHTML = "";

        items.forEach((item) => {
          const cardId = favoritesManager.cardIdManager.getCardId(
            item,
            "order"
          );
          const cardElement = document.createElement("div");
          cardElement.className = "card";
          cardElement.dataset.cardId = cardId;
          cardElement.innerHTML = `
                    <div>
                        <strong>${item.name}</strong><br>
                        <span>${item.price.toLocaleString()} ‚ÇΩ ‚Ä¢ ${
            item.area
          } –º¬≤</span>
                        <div class="id-display">ID: ${cardId}</div>
                    </div>
                    <button class="like-button" onclick="toggleFavorite('${cardId}')">‚ô°</button>
                `;
          container.appendChild(cardElement);
        });

        favoritesManager.updateCards();
      }

      function sortBy(sortType) {
        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
        document.querySelectorAll(".sort-button").forEach((btn) => {
          btn.classList.remove("active");
        });
        event.target.classList.add("active");

        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
        const sortedItems = favoritesManager.sortItems(testData, sortType);
        renderCards(sortedItems);

        console.log(
          `–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ ${sortType}:`,
          sortedItems.map((item) => ({
            name: item.name,
            id: favoritesManager.cardIdManager.getCardId(item, "order"),
          }))
        );
      }

      function toggleFavorite(cardId) {
        favoritesManager.toggleFavorite(cardId);
      }

      function clearFavorites() {
        favoritesManager.clearFavorites();
      }

      function runUniqueIdTests() {
        const results = document.getElementById("test-results");
        results.textContent = "–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö ID...\n";

        let passed = 0;
        let total = 0;

        // –¢–µ—Å—Ç 1: –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å ID
        total++;
        const ids = testData.map((item) =>
          favoritesManager.cardIdManager.getCardId(item, "order")
        );
        const uniqueIds = new Set(ids);
        if (uniqueIds.size === ids.length) {
          results.textContent += "‚úÖ ID –∫–∞—Ä—Ç–æ—á–µ–∫ —É–Ω–∏–∫–∞–ª—å–Ω—ã\n";
          passed++;
        } else {
          results.textContent += "‚ùå –ù–∞–π–¥–µ–Ω—ã –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è ID\n";
        }

        // –¢–µ—Å—Ç 2: –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å ID –ø—Ä–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–µ
        total++;
        const originalIds = testData.map((item) =>
          favoritesManager.cardIdManager.getCardId(item, "order")
        );
        const sortedData = favoritesManager.sortItems(testData, "price-asc");
        const sortedIds = sortedData.map((item) =>
          favoritesManager.cardIdManager.getCardId(item, "order")
        );

        const originalSet = new Set(originalIds);
        const sortedSet = new Set(sortedIds);
        const setsEqual =
          originalSet.size === sortedSet.size &&
          [...originalSet].every((id) => sortedSet.has(id));

        if (setsEqual) {
          results.textContent += "‚úÖ ID –æ—Å—Ç–∞—é—Ç—Å—è —Å—Ç–∞–±–∏–ª—å–Ω—ã–º–∏ –ø—Ä–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–µ\n";
          passed++;
        } else {
          results.textContent += "‚ùå ID –∏–∑–º–µ–Ω—è—é—Ç—Å—è –ø—Ä–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–µ\n";
        }

        // –¢–µ—Å—Ç 3: –ü–∞—Ä—Å–∏–Ω–≥ ID
        total++;
        const testId = originalIds[0];
        const parsed = favoritesManager.cardIdManager.parseCardId(testId);
        if (parsed && parsed.tab === "order" && parsed.name) {
          results.textContent += "‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ ID —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ\n";
          passed++;
        } else {
          results.textContent += "‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ ID\n";
        }

        results.textContent += `\n–†–µ–∑—É–ª—å—Ç–∞—Ç: ${passed}/${total} —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ`;

        if (passed === total) {
          results.textContent += "\nüéâ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!";
        } else {
          results.textContent += "\n‚ö†Ô∏è –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ç–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ–π–¥–µ–Ω—ã";
        }
      }

      function testSortingWithLikes() {
        const results = document.getElementById("test-results");
        results.textContent = "–¢–µ—Å—Ç —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —Å –ª–∞–π–∫–∞–º–∏...\n";

        // –û—á–∏—â–∞–µ–º –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
        favoritesManager.clearFavorites();

        // –î–æ–±–∞–≤–ª—è–µ–º –ª–∞–π–∫–∏ –Ω–∞ –ø–µ—Ä–≤—ã–µ 3 –∫–∞—Ä—Ç–æ—á–∫–∏
        const firstThree = testData.slice(0, 3);
        firstThree.forEach((item) => {
          const cardId = favoritesManager.cardIdManager.getCardId(
            item,
            "order"
          );
          favoritesManager.toggleFavorite(cardId);
        });

        results.textContent += `–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ: ${favoritesManager.getFavoritesCount()} –∫–∞—Ä—Ç–æ—á–µ–∫\n`;

        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Ü–µ–Ω–µ
        const sortedItems = favoritesManager.sortItems(testData, "price-asc");
        renderCards(sortedItems);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ª–∞–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏—Å—å
        setTimeout(() => {
          const likedCards = document.querySelectorAll(".card.favorite");
          if (likedCards.length === 3) {
            results.textContent += "‚úÖ –õ–∞–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏—Å—å –ø–æ—Å–ª–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏!\n";
          } else {
            results.textContent += `‚ùå –û—à–∏–±–∫–∞: –ø–æ–∫–∞–∑–∞–Ω–æ ${likedCards.length} –ª–∞–π–∫–æ–≤, –æ–∂–∏–¥–∞–ª–æ—Å—å 3\n`;
          }
        }, 100);
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
      document.addEventListener("DOMContentLoaded", () => {
        const status = document.getElementById("status");
        status.textContent = "‚úÖ –°–∏—Å—Ç–µ–º–∞ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö ID –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ";
        status.className = "status success";

        renderCards(testData);
      });
    </script>
  </body>
</html>
