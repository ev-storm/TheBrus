<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Тест избранного - Финальная версия</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: #1a1a1a;
        color: white;
      }
      .test-section {
        background: #2a2a2a;
        padding: 20px;
        margin: 20px 0;
        border-radius: 8px;
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
      }
      .success {
        background: #4caf50;
      }
      .error {
        background: #f44336;
      }
      .info {
        background: #2196f3;
      }
      .test-button {
        background: #65c36c;
        color: white;
        border: none;
        padding: 10px 20px;
        margin: 5px;
        border-radius: 4px;
        cursor: pointer;
      }
      .test-button:hover {
        background: #5ab060;
      }
      .favorites-list {
        background: #333;
        padding: 15px;
        border-radius: 4px;
        margin: 10px 0;
      }
      .card {
        background: #444;
        padding: 15px;
        margin: 10px 0;
        border-radius: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .like-button {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        font-size: 20px;
      }
      .like-button.liked {
        color: #65c36c;
      }
    </style>
  </head>
  <body>
    <h1>Тест избранного - Финальная версия</h1>

    <div class="test-section">
      <h2>Статус тестирования</h2>
      <div id="status" class="status info">Инициализация...</div>
      <div class="favorites-list">
        <strong>Избранное:</strong>
        <span id="favorites-count">0</span> элементов
        <div id="favorites-list"></div>
      </div>
    </div>

    <div class="test-section">
      <h2>Тестовые карточки</h2>
      <div id="cards-container">
        <!-- Карточки будут добавлены динамически -->
      </div>
    </div>

    <div class="test-section">
      <h2>Управление</h2>
      <button class="test-button" onclick="clearFavorites()">
        Очистить избранное
      </button>
      <button class="test-button" onclick="addTestCards()">
        Добавить тестовые карточки
      </button>
      <button class="test-button" onclick="testCookiePersistence()">
        Тест сохранения в cookies
      </button>
    </div>

    <script>
      // Симуляция useFavorites с cookies
      class FavoritesManager {
        constructor() {
          this.cookieName = "favorites";
          this.favorites = this.loadFromCookie();
          this.updateDisplay();
        }

        loadFromCookie() {
          try {
            const cookie = document.cookie
              .split("; ")
              .find((row) => row.startsWith(this.cookieName + "="));
            if (cookie) {
              const value = cookie.split("=")[1];
              return JSON.parse(decodeURIComponent(value));
            }
          } catch (e) {
            console.error("Ошибка загрузки из cookie:", e);
          }
          return [];
        }

        saveToCookie() {
          try {
            const value = encodeURIComponent(JSON.stringify(this.favorites));
            document.cookie = `${this.cookieName}=${value}; max-age=${
              60 * 60 * 24 * 365
            }; path=/; samesite=lax`;
          } catch (e) {
            console.error("Ошибка сохранения в cookie:", e);
          }
        }

        toggleFavorite(itemId) {
          const index = this.favorites.indexOf(itemId);
          if (index > -1) {
            this.favorites.splice(index, 1);
            console.log("Удалено из избранного:", itemId);
          } else {
            this.favorites.push(itemId);
            console.log("Добавлено в избранное:", itemId);
          }
          this.saveToCookie();
          this.updateDisplay();
          this.updateCards();
        }

        isFavorite(itemId) {
          return this.favorites.includes(itemId);
        }

        getFavoritesCount() {
          return this.favorites.length;
        }

        clearFavorites() {
          this.favorites = [];
          this.saveToCookie();
          this.updateDisplay();
          this.updateCards();
        }

        updateDisplay() {
          document.getElementById("favorites-count").textContent =
            this.getFavoritesCount();
          const list = document.getElementById("favorites-list");
          list.innerHTML =
            this.favorites.length > 0
              ? this.favorites.map((id) => `<div>• ${id}</div>`).join("")
              : "<div>Пусто</div>";
        }

        updateCards() {
          const cards = document.querySelectorAll(".card");
          cards.forEach((card) => {
            const cardId = card.dataset.cardId;
            const likeButton = card.querySelector(".like-button");
            if (likeButton) {
              likeButton.classList.toggle("liked", this.isFavorite(cardId));
            }
          });
        }
      }

      const favoritesManager = new FavoritesManager();

      function addTestCards() {
        const container = document.getElementById("cards-container");
        container.innerHTML = "";

        const testCards = [
          { id: "order-0", title: "Карточка 1", price: "1000000" },
          { id: "order-1", title: "Карточка 2", price: "2000000" },
          { id: "order-2", title: "Карточка 3", price: "1500000" },
          { id: "portfolio-0", title: "Портфолио 1", price: "3000000" },
          { id: "portfolio-1", title: "Портфолио 2", price: "2500000" },
        ];

        testCards.forEach((card) => {
          const cardElement = document.createElement("div");
          cardElement.className = "card";
          cardElement.dataset.cardId = card.id;
          cardElement.innerHTML = `
                    <div>
                        <strong>${card.title}</strong><br>
                        <span>${card.price} ₽</span>
                    </div>
                    <button class="like-button" onclick="toggleFavorite('${card.id}')">♡</button>
                `;
          container.appendChild(cardElement);
        });

        favoritesManager.updateCards();
      }

      function toggleFavorite(cardId) {
        favoritesManager.toggleFavorite(cardId);
      }

      function clearFavorites() {
        favoritesManager.clearFavorites();
      }

      function testCookiePersistence() {
        const status = document.getElementById("status");
        status.textContent = "Тестирование сохранения в cookies...";
        status.className = "status info";

        // Добавляем элемент в избранное
        favoritesManager.toggleFavorite("test-persistence");

        setTimeout(() => {
          // Проверяем, что элемент сохранился
          if (favoritesManager.isFavorite("test-persistence")) {
            status.textContent = "✅ Cookies работают корректно!";
            status.className = "status success";
          } else {
            status.textContent = "❌ Ошибка сохранения в cookies";
            status.className = "status error";
          }
        }, 100);
      }

      // Инициализация
      document.addEventListener("DOMContentLoaded", () => {
        const status = document.getElementById("status");
        status.textContent = "✅ Система избранного инициализирована";
        status.className = "status success";

        addTestCards();
      });
    </script>
  </body>
</html>
